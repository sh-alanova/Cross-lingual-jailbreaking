# ML System Design Document - [RU]
## Дизайн ML системы -  Обнаружение мультиязычных вредоносных запросов с помощью семантического анализа

### 1. Цели и предпосылки

#### 1.1. Зачем идем в разработку продукта?

**Бизнес-цель (Product Owner):**

Повышение устойчивости LLM-систем к манипулятивным запросам на языках, отличных от английского, за счёт раннего обнаружения вредоносного намерения до передачи запроса модели. 
Это снижает риски генерации опасного или нарушающего политику контента в мультиязычных интерфейсах.

**Почему станет лучше:**  

Существующие системы фильтрации часто обучены только на английском языке и не учитывают семантическую близость запросов на других языках к известным вредоносным паттернам. 
Предлагаемый подход использует **семантические эмбеддинги**, что позволяет детектировать злонамеренные запросы независимо от языка их формулировки — особенно важно для глобальных продуктов.

**Критерий успеха итерации:**  

Снижение доли успешных jailbreak-атак на ≥10% при тестировании на переведённых датасетах по сравнению с отсутствием фильтрации.

---

#### 1.2. Бизнес-требования и ограничения

**Краткое описание бизнес-требований:**  

- Нет формальных бизнес-требований. Цель — проверка научной гипотезы:
  
  > Семантическое сходство между вредоносными промптами на английском языке и их переводами на другие языки (например, русский, китайский) достаточно высоко, чтобы позволить обнаруживать
  > мультиязычных вредоносные атаки, используя только эмбеддинги, обученные на английском, без явного их перевода.
  
- Поддержка как минимум 3 языков: английский, русский, китайский 

**Бизнес-ограничения:**  

- Нельзя использовать закрытые/платные эмбеддинг-модели без лицензирования.
- Нельзя использовать платные API (только открытые модели).
- Нет необходимости в развертывании — только эксперимент в Jupyter/Python.

**Ожидания от итерации:**  

- Доказать техническую осуществимость и эффективность подхода на основе семантической векторной базы вредоносных намерений. 
- Получить метрики качества, достаточные для принятия решения о дальнейшей продуктивизации/интеграции.

**Описание бизнес-процесса пилота:**  

  Пилот представляет собой контролируемый эксперимент: на наборе синтетических и открытых вредоносных запросов оценивается способность фильтра обнаруживать вредоносные атаки, без внешней интеграции.

**Критерии успешного пилота:**  

- УУспешный пилот: модель показывает значимое улучшение по сравнению с отсутствием фильтра.  
- Возможность быстрой адаптации под новые языки и типов атак.  
- Путь развития: интеграция в safety stack и переход к онлайн-инференсу.

---

#### 1.3. Скоуп проекта/итерации

**Что входит:**  

- Перевод датасета на 2 целевых языка (русский и китайский) + валидация качества перевода.  
- Построение семантический векторной базы вредоносных намерений
- Проверка гипотезы о применимости семантического анализа для обнаружения вредоносных запросов на отличных от английского языках.
- Оценка эффективности фильтра на переведённых вредоносных промптах
- Подготовка воспроизводимого пайплайна (Docker + config files + evaluation script).


**Что не входит:**  

- Обучение собственных эмбеддингов.
- Онлайн-инференс или масштабирование системы.
- Разработка UI/UX компонентов.  
- Обучение новой LLM.  
- Интеграция в production API (только offline-оценка и mock inference).  

**Описание результата с точки зрения качества кода и воспроизводимости решения:**  

- Код размещён в публичном репозитории с .pre-commit-config.yaml, pyproject.toml, requirements.txt.
- Все зависимости зафиксированы, конфигурации параметризованы.
- Эксперимент воспроизводится через Jupyter notebook или скрипт.

**Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации):**  

- Отсутствие оптимизированного поиска (FAISS/HNSW)..
- Отсутствие онлайн-инференс-сервиса (только batch/offline).  
- Нет механизма обновления векторной базы в runtime.

---

#### 1.4. Предпосылки решения

- **Данные:** Используются открытые датасеты вредоносных промптов.  
- **Горизонт прогноза:** Instant — решение принимается per-query.  
- **Гранулярность:** На уровне одного текстового запроса.
- **Предположение:** Семантические эмбеддинги сохраняют смысл при переводе — т.е. перевод вредоносного промпта остаётся близок к оригиналу в векторном пространстве.
- **Модель:** Используется предобученный multilingual sentence transformer `BAAI/bge-m3` — не требуется обучение с нуля.

---


### 2. Методология

#### 2.1. Постановка задачи

Задача формулируется как **семантическая классификация намерений**: определить, принадлежит ли входной запрос к множеству «вредоносных намерений», представленных в виде кодбука эмбеддингов. Это задача **поиска аномалий** на основе косинусного сходства.

---

#### 2.2. Блок-схема решения

```
[Входной запрос]  
        ↓  
[Эмбеддинг: BAAI/bge-m3] → получаем вектор [1024d]  
        ↓  
[Сравнение: косинусное сходство с каждым вектором в кодбуком]  
        ↓  
[Максимальное сходство > τ?]  
        │  
        ├── Да → [ЗАБЛОКИРОВАН]  
        └── Нет → [ПРОПУЩЕН]  
```

#### 2.3. Этапы решения задачи

1. Подготовка данных

2. Подготовка бенчмарков (сбор различных бенчмарков и перевод на русский и китайский)

3. Построение кодбука

4. Подбор порога τ на валидационной выборке.

5. ...
